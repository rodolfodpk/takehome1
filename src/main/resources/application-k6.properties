# K6 Performance Testing Profile
# Relaxed resilience settings for performance testing
# Circuit breakers remain enabled for spike test validation, but with relaxed thresholds

# Server Configuration
server.port=${SERVER_PORT:8080}

# Database Configuration
spring.r2dbc.url=${SPRING_R2DBC_URL:r2dbc:postgresql://localhost:5432/takehome1}
spring.r2dbc.username=${SPRING_R2DBC_USERNAME:takehome1}
spring.r2dbc.password=${SPRING_R2DBC_PASSWORD:takehome1}

# R2DBC Connection Factory Timeout Configuration
# Extended timeouts for high load scenarios
spring.r2dbc.properties.connectTimeout=5s
spring.r2dbc.properties.statementTimeout=8s

# R2DBC Connection Pool Configuration
# Same as production - optimized for 4 CPU cores with headroom for 2k+ events/sec
spring.r2dbc.pool.initial-size=10
spring.r2dbc.pool.max-size=30
spring.r2dbc.pool.max-idle-time=30m
spring.r2dbc.pool.max-acquire-time=30s
spring.r2dbc.pool.max-create-connection-time=30s

# Flyway Configuration
spring.flyway.url=${SPRING_FLYWAY_URL:jdbc:postgresql://localhost:5432/takehome1}
spring.flyway.user=${SPRING_FLYWAY_USER:takehome1}
spring.flyway.password=${SPRING_FLYWAY_PASSWORD:takehome1}
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true

# Redis Configuration (Redisson)
spring.data.redis.host=${SPRING_REDIS_HOST:localhost}
spring.data.redis.port=${SPRING_REDIS_PORT:6379}
spring.data.redis.password=${SPRING_REDIS_PASSWORD:takehome1}
spring.data.redis.timeout=5000ms

# Redis Connection Pool Configuration
# Increased for k6 performance testing: 48 max connections for higher concurrency
spring.redis.pool.max-size=48
spring.redis.pool.min-idle-size=12

# SpringDoc OpenAPI Configuration
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.path=/swagger-ui.html

# Actuator Configuration
management.endpoints.web.exposure.include=health,info,prometheus,metrics,circuitbreakers,circuitbreakerevents
management.endpoint.health.show-details=when-authorized

# Metrics Configuration
management.metrics.export.prometheus.enabled=true
management.metrics.tags.application=takehome1
management.metrics.tags.environment=${ENVIRONMENT:k6-testing}
management.metrics.tags.version=0.0.1-SNAPSHOT

# Enable histogram buckets for HTTP metrics (required for percentile calculations)
management.metrics.distribution.percentiles-histogram.http.server.requests.enabled=true
management.metrics.distribution.sla.http.server.requests=10ms,50ms,100ms,200ms,500ms,1s,2s,5s

# Resilience4j Configuration - PostgreSQL
# Circuit breakers DISABLED for k6 performance testing (warmup, smoke, load, stress)
# By not configuring circuit breakers, they won't be auto-created by Spring Boot
# The code will skip applying circuit breakers if they don't exist in the registry
# To enable circuit breakers for spike tests, use SPRING_PROFILES_ACTIVE=k6,k6-spike
# (k6-spike profile has circuit breakers enabled)

# Reduced retries for performance (effectively disabled - maxAttempts=1 means no retries)
resilience4j.retry.instances.postgres.maxAttempts=1
resilience4j.retry.instances.postgres.waitDuration=1000
resilience4j.retry.instances.postgres.retryExceptions=org.springframework.r2dbc.BadSqlGrammarException,io.r2dbc.spi.R2dbcException

# Time limiters DISABLED for k6 performance testing
# Removed to avoid artificial timeouts during load tests and get accurate performance metrics
# Time limiters are still applied in code but will be skipped if not configured

# Resilience4j Configuration - Redis
# Circuit breakers DISABLED for k6 performance testing (warmup, smoke, load, stress)
# By not configuring circuit breakers, they won't be auto-created by Spring Boot
# The code will skip applying circuit breakers if they don't exist in the registry
# To enable circuit breakers for spike tests, use SPRING_PROFILES_ACTIVE=k6,k6-spike
# (k6-spike profile has circuit breakers enabled)

# Reduced retries for performance (effectively disabled - maxAttempts=1 means no retries)
resilience4j.retry.instances.redis.maxAttempts=1
resilience4j.retry.instances.redis.waitDuration=500
resilience4j.retry.instances.redis.retryExceptions=org.redisson.client.RedisException,java.net.ConnectException

# Time limiters DISABLED for k6 performance testing
# Removed to avoid artificial timeouts during load tests and get accurate performance metrics
# Time limiters are still applied in code but will be skipped if not configured

# Metering Configuration
metering.window.duration-seconds=30
metering.aggregation.processing-interval-ms=30000
metering.late-event.grace-period-minutes=5
metering.late-event.processing-interval-ms=300000
metering.late-event.batch-size=100
metering.late-event.threshold-minutes=1
metering.event.batch-size=100
metering.event.batch-interval-seconds=5
metering.event.persistence-interval-ms=2000
metering.event.persistence-batch-size=1000
metering.lock.timeout-seconds=5
metering.lock.lease-time-seconds=60
metering.lock.default-timeout-seconds=30
metering.lock.default-lease-time-seconds=60
metering.redis.counter-ttl-seconds=3600
metering.redis.event-ttl-hours=1

# WebFlux/Netty Tuning
# Match CPU cores for optimal performance
reactor.netty.ioWorkerCount=4

# Logging - Reduced verbosity for performance testing
logging.level.com.rdpk=WARN
logging.level.org.springframework.r2dbc=WARN
logging.level.org.springframework.data.redis=WARN
logging.level.io.r2dbc=WARN

