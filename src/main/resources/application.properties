# Server Configuration
server.port=${SERVER_PORT:8080}

# Database Configuration
spring.r2dbc.url=${SPRING_R2DBC_URL:r2dbc:postgresql://localhost:5432/takehome1}
spring.r2dbc.username=${SPRING_R2DBC_USERNAME:takehome1}
spring.r2dbc.password=${SPRING_R2DBC_PASSWORD:takehome1}

# R2DBC Connection Factory Timeout Configuration
# Connection timeout (3s) - connection establishment
# Statement timeout (4s) - query execution
spring.r2dbc.properties.connectTimeout=3s
spring.r2dbc.properties.statementTimeout=4s

# R2DBC Connection Pool Configuration
# Optimized for 4 CPU cores: 4x cores = 16 (guideline), 30 provides headroom for 2k+ events/sec
spring.r2dbc.pool.initial-size=10
spring.r2dbc.pool.max-size=30
spring.r2dbc.pool.max-idle-time=30m
spring.r2dbc.pool.max-acquire-time=30s
spring.r2dbc.pool.max-create-connection-time=30s

# Flyway Configuration
spring.flyway.url=${SPRING_FLYWAY_URL:jdbc:postgresql://localhost:5432/takehome1}
spring.flyway.user=${SPRING_FLYWAY_USER:takehome1}
spring.flyway.password=${SPRING_FLYWAY_PASSWORD:takehome1}
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true

# Redis Configuration (Redisson)
spring.data.redis.host=${SPRING_REDIS_HOST:localhost}
spring.data.redis.port=${SPRING_REDIS_PORT:6379}
spring.data.redis.password=${SPRING_REDIS_PASSWORD:takehome1}
spring.data.redis.timeout=3000ms

# Redis Connection Pool Configuration
# Optimized for 4 CPU cores: 32 max connections provides good concurrency without resource contention
spring.redis.pool.max-size=32
spring.redis.pool.min-idle-size=8

# SpringDoc OpenAPI Configuration
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.path=/swagger-ui.html

# Actuator Configuration
management.endpoints.web.exposure.include=health,info,prometheus,metrics,circuitbreakers,circuitbreakerevents
management.endpoint.health.show-details=always

# Metrics Configuration
management.metrics.export.prometheus.enabled=true
management.metrics.tags.application=takehome1
management.metrics.tags.environment=${ENVIRONMENT:production}
management.metrics.tags.version=0.0.1-SNAPSHOT

# Enable histogram buckets for HTTP metrics (required for percentile calculations)
management.metrics.distribution.percentiles-histogram.http.server.requests.enabled=true
management.metrics.distribution.sla.http.server.requests=10ms,50ms,100ms,200ms,500ms,1s,2s,5s

# Resilience4j Configuration - PostgreSQL
resilience4j.circuitbreaker.instances.postgres.slidingWindowSize=10
resilience4j.circuitbreaker.instances.postgres.minimumNumberOfCalls=5
resilience4j.circuitbreaker.instances.postgres.failureRateThreshold=50
resilience4j.circuitbreaker.instances.postgres.waitDurationInOpenState=60000
resilience4j.circuitbreaker.instances.postgres.permittedNumberOfCallsInHalfOpenState=3

resilience4j.retry.instances.postgres.maxAttempts=3
resilience4j.retry.instances.postgres.waitDuration=1000
resilience4j.retry.instances.postgres.retryExceptions=org.springframework.r2dbc.BadSqlGrammarException,io.r2dbc.spi.R2dbcException

resilience4j.timelimiter.instances.postgres.timeoutDuration=5s

# Resilience4j Configuration - Redis
resilience4j.circuitbreaker.instances.redis.slidingWindowSize=10
resilience4j.circuitbreaker.instances.redis.minimumNumberOfCalls=5
resilience4j.circuitbreaker.instances.redis.failureRateThreshold=50
resilience4j.circuitbreaker.instances.redis.waitDurationInOpenState=30000
resilience4j.circuitbreaker.instances.redis.permittedNumberOfCallsInHalfOpenState=3

resilience4j.retry.instances.redis.maxAttempts=3
resilience4j.retry.instances.redis.waitDuration=500
resilience4j.retry.instances.redis.retryExceptions=org.redisson.client.RedisException,java.net.ConnectException

resilience4j.timelimiter.instances.redis.timeoutDuration=3s

# Metering Configuration
metering.window.duration-seconds=30
metering.aggregation.processing-interval-ms=30000
metering.late-event.grace-period-minutes=5
metering.late-event.processing-interval-ms=300000
metering.late-event.batch-size=100
metering.late-event.threshold-minutes=1
metering.event.batch-size=100
metering.event.batch-interval-seconds=5
metering.event.persistence-interval-ms=2000
metering.event.persistence-batch-size=1000
metering.lock.timeout-seconds=5
metering.lock.lease-time-seconds=60
metering.lock.default-timeout-seconds=30
metering.lock.default-lease-time-seconds=60
metering.redis.counter-ttl-seconds=3600
metering.redis.event-ttl-hours=1

# Logging
logging.level.com.rdpk=INFO
logging.level.org.springframework.r2dbc=INFO
logging.level.org.springframework.data.redis=INFO

